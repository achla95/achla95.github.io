<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../../images/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="styles.css">
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <title>CryptoHack : Passwords as Keys</title>
</head>
<body>
    <div class="nav-bar">
        <a class="img-a" href="../../index.html"><img src="../../images/logo.png" alt="here" style="width: 65px;"></a>
                <nav>
                    <div class="dropdown">
                        <a class="nav-item" href="../../index.html"style="color: #F5F5F5; background: #111927; font-weight: 800; border-radius: 4px;">Home</a>
                    </div>
                    <div class="dropdown">
                        <a class="nav-item" href="../../whoami/me.html">Whoami</a>
                    </div>
                    <div class="dropdown">
                        <a>Catégories<i class="fas fa-sort-down"></i></a>
                        <div class="dropdown-content">
                            <a href="#">Web</a>
                            <a href="#">Crypto</a>
                            <a href="#">Pentest</a>
                        </div>
                    </div>
                </nav>
            </div>
            <div class="nav-bar-phone ">
                <a href="../../index.html"><img src="../../images/logo.png" alt="here" style="width: 65px;"></a>
                <div class="burger ">
                    <span></span>
                </div>
                <nav>
                    <div class="dropdown ">
                        <a class="nav-item" href="../../index.html" style="text-decoration: none; color: #8F96A3;">Home</a>
                    </div>
                    <div class="dropdown ">
                        <a href="../../whoami/me.html" class="nav-item" style="text-decoration: none; color: #8F96A3;">Whoami</a>
                    </div>
                    <div class="dropdown ">
                        <a>Catégories<i class="fas fa-sort-down "></i></a>
                        <div class="dropdown-content ">
                            <a href="#">Web</a>
                            <a href="#">Crypto</a>
                            <a href="#">Pentest</a>
                        </div>
                    </div>

                </nav>
            </div>
            <div class="header">
                <div id="post-list">
                        <article>
                                <h2 class="entry-title" style="color: #FEB32B;"> CryptoHack : Passwords as Keys</h2>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <time class="published" datetime="2021-08-14T00:00:00+02:00"> jeu. 5 avril 2022 </time>
                                <b>·</b>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                        <label><a style="color: #FEB32B;">achla</a></label>
                                <b>·</b>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                <label>medium</label>
                                <p> <p>On se retrouve pour un write-up vidéo d'un challenge venant de <a href="https://cryptohack.org" target="_blank" style="text-decoration: none; color: #FEB32B;">CryptoHack</a>.</p></p>
                                <p>Énoncé : 
                                    It is essential that keys in symmetric-key algorithms are random bytes, instead of passwords or other predictable data. The random bytes should be generated using a cryptographically-secure pseudorandom number generator (CSPRNG). If the keys are predictable in any way, then the security level of the cipher is reduced and it may be possible for an attacker who gets access to the ciphertext to decrypt it.
                                </p>
                                <p>
                                    Just because a key looks like it is formed of random bytes, does not mean that it necessarily is. In this case the key has been derived from a simple password using a hashing function, which makes the ciphertext crackable.

For this challenge you may script your HTTP requests to the endpoints, or alternatively attack the ciphertext offline. Good luck!

Play at <a href="http://aes.cryptohack.org/passwords_as_keys" target="_blank" style="color: #FEB32B;">http://aes.cryptohack.org/passwords_as_keys</a>
                                </p>
                                <p>
                                    En se rendant sur le lien spécifié ci-dessus, nous voyons le script python qui permet de chiffrer et déchiffrer le flag : 
                                    <!-- HTML generated using hilite.me --><div style="background: #202020; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #6ab825; font-weight: bold">from</span> <span style="color: #447fcf; text-decoration: underline">Crypto.Cipher</span> <span style="color: #6ab825; font-weight: bold">import</span> <span style="color: #d0d0d0">AES</span>
    <span style="color: #6ab825; font-weight: bold">import</span> <span style="color: #447fcf; text-decoration: underline">hashlib</span>
    <span style="color: #6ab825; font-weight: bold">import</span> <span style="color: #447fcf; text-decoration: underline">random</span>
    
    
    <span style="color: #999999; font-style: italic"># /usr/share/dict/words from</span>
    <span style="color: #999999; font-style: italic"># https://gist.githubusercontent.com/wchargin/8927565/raw/d9783627c731268fb2935a731a618aa8e95cf465/words</span>
    <span style="color: #6ab825; font-weight: bold">with</span> <span style="color: #24909d">open</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;/usr/share/dict/words&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #d0d0d0">f:</span>
        <span style="color: #d0d0d0">words</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[w.strip()</span> <span style="color: #6ab825; font-weight: bold">for</span> <span style="color: #d0d0d0">w</span> <span style="color: #6ab825; font-weight: bold">in</span> <span style="color: #d0d0d0">f.readlines()]</span>
    <span style="color: #d0d0d0">keyword</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">random.choice(words)</span>
    
    <span style="color: #d0d0d0">KEY</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">hashlib.md5(keyword.encode()).digest()</span>
    <span style="color: #d0d0d0">FLAG</span> <span style="color: #d0d0d0">=</span> <span style="color: #a61717; background-color: #e3d2d2">?</span>
    
    
    <span style="color: #ffa500">@chal.route</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;/passwords_as_keys/decrypt/&lt;ciphertext&gt;/&lt;password_hash&gt;/&#39;</span><span style="color: #d0d0d0">)</span>
    <span style="color: #6ab825; font-weight: bold">def</span> <span style="color: #447fcf">decrypt</span><span style="color: #d0d0d0">(ciphertext,</span> <span style="color: #d0d0d0">password_hash):</span>
        <span style="color: #d0d0d0">ciphertext</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">bytes</span><span style="color: #d0d0d0">.fromhex(ciphertext)</span>
        <span style="color: #d0d0d0">key</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">bytes</span><span style="color: #d0d0d0">.fromhex(password_hash)</span>
    
        <span style="color: #d0d0d0">cipher</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">AES.new(key,</span> <span style="color: #d0d0d0">AES.MODE_ECB)</span>
        <span style="color: #6ab825; font-weight: bold">try</span><span style="color: #d0d0d0">:</span>
            <span style="color: #d0d0d0">decrypted</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">cipher.decrypt(ciphertext)</span>
        <span style="color: #6ab825; font-weight: bold">except</span> <span style="color: #bbbbbb">ValueError</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #d0d0d0">e:</span>
            <span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #d0d0d0">{</span><span style="color: #ed9d13">&quot;error&quot;</span><span style="color: #d0d0d0">:</span> <span style="color: #24909d">str</span><span style="color: #d0d0d0">(e)}</span>
    
        <span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #d0d0d0">{</span><span style="color: #ed9d13">&quot;plaintext&quot;</span><span style="color: #d0d0d0">:</span> <span style="color: #d0d0d0">decrypted.hex()}</span>
    
    
    <span style="color: #ffa500">@chal.route</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;/passwords_as_keys/encrypt_flag/&#39;</span><span style="color: #d0d0d0">)</span>
    <span style="color: #6ab825; font-weight: bold">def</span> <span style="color: #447fcf">encrypt_flag</span><span style="color: #d0d0d0">():</span>
        <span style="color: #d0d0d0">cipher</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">AES.new(KEY,</span> <span style="color: #d0d0d0">AES.MODE_ECB)</span>
        <span style="color: #d0d0d0">encrypted</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">cipher.encrypt(FLAG.encode())</span>
    
        <span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #d0d0d0">{</span><span style="color: #ed9d13">&quot;ciphertext&quot;</span><span style="color: #d0d0d0">:</span> <span style="color: #d0d0d0">encrypted.hex()}</span>
    </pre></div>
    
                                </p>
                    <p>
                        On remarque la clé utilisée pour chiffrer le flag est issue d'une wordlist, à partir de la rien de compliqué il nous suffit
                        juste de récupérer cette wordlist puis de hasher tout les mots. Enfin, nous devons déchiffrer le flag avec tous les mots que nous venont de hasher
                    </p>
                    <p>
                        Pour cela j'ai fait un petit script python qui permet d'automatiser cette opération : 
<!-- HTML generated using hilite.me --><div style="background: #202020; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #6ab825; font-weight: bold">from</span> <span style="color: #447fcf; text-decoration: underline">Crypto.Cipher</span> <span style="color: #6ab825; font-weight: bold">import</span> <span style="color: #d0d0d0">AES</span>
    <span style="color: #6ab825; font-weight: bold">import</span> <span style="color: #447fcf; text-decoration: underline">hashlib</span>

    <span style="color: #6ab825; font-weight: bold">with</span> <span style="color: #24909d">open</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;C:\\Users\\achla95\\Documents\\CryptoHack\\AES_Second_Part\\words&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">encoding=</span><span style="color: #ed9d13">&quot;utf-8&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #d0d0d0">f:</span>
        <span style="color: #d0d0d0">words</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[w.strip()</span> <span style="color: #6ab825; font-weight: bold">for</span> <span style="color: #d0d0d0">w</span> <span style="color: #6ab825; font-weight: bold">in</span> <span style="color: #d0d0d0">f.readlines()]</span>
    
    
    <span style="color: #d0d0d0">hashed_words</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[]</span>
    <span style="color: #6ab825; font-weight: bold">for</span> <span style="color: #d0d0d0">w</span> <span style="color: #6ab825; font-weight: bold">in</span> <span style="color: #d0d0d0">words:</span>
        <span style="color: #d0d0d0">hashed_words.append(hashlib.md5(w.encode()).digest())</span>
    
    
    <span style="color: #d0d0d0">ciphertext</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;c92b7734070205bdf6c0087a751466ec13ae15e6f1bcdd3f3a535ec0f4bbae66&quot;</span>
    
    <span style="color: #d0d0d0">ciphertext</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">bytes</span><span style="color: #d0d0d0">.fromhex(ciphertext)</span>
    <span style="color: #6ab825; font-weight: bold">for</span> <span style="color: #d0d0d0">w</span> <span style="color: #6ab825; font-weight: bold">in</span> <span style="color: #d0d0d0">hashed_words:</span>
        <span style="color: #d0d0d0">cipher</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">AES.new(w,</span> <span style="color: #d0d0d0">AES.MODE_ECB)</span>
        <span style="color: #d0d0d0">decrypted=</span> <span style="color: #d0d0d0">cipher.decrypt(ciphertext)</span>
        <span style="color: #6ab825; font-weight: bold">if</span> <span style="color: #d0d0d0">decrypted.hex().startswith(</span><span style="color: #ed9d13">&quot;63727970746f&quot;</span><span style="color: #d0d0d0">):</span>
            <span style="color: #6ab825; font-weight: bold">print</span><span style="color: #d0d0d0">(f</span><span style="color: #ed9d13">&quot;found hash: {w.hex()}, decrypted : {decrypted.hex()}&quot;</span><span style="color: #d0d0d0">)</span>
            <span style="color: #6ab825; font-weight: bold">break</span>
    </pre></div>
    

                    </p>
                    <p>En quelques mots, on sait que notre flag commence par <span  style="color: #FEB32B;">crypto{</span>, de là on converti cela en hexadécimal et on vérifie
                       si notre message déchiffrer commence par : <span style="color: #FEB32B;">63727970746f</span>, si c'est le cas, le tour est joué, nous avons notre flag.
                    </p>
                    <p>And Voilà, c'était plutôt simple, je me suis remis à ma crypto récemment et je me rendu compte que je ne connaissais pas le chiffrement AES
                        qui est un chiffrement sécurisé (quand on l'utilise bien) et puissant. La prochaine fois nous nous retrouverons pour un challenge un cran au dessus de celui-ci.
                    </p>
                        </article>
                        
                </div>
            </div>
</body>
<script>
    var burger = document.querySelector('.burger');
    var navbar = document.querySelector('.nav-bar-phone nav');
    used = false;

    burger.addEventListener('click', function () {
        if (used) {
        navbar.classList.toggle('on');
        $('*:not(.nav-bar-phone, .nav-bar-phone *, body, html)').show();
        $('.nav-bar').hide();
        $('head *').hide();
        $('body').css("background", "#ecf0f1");
        used = false;
        console.log(used);
  } else {
    navbar.classList.toggle('on');
    $('*:not(.nav-bar-phone, .nav-bar-phone *, body, html)').hide();
    $('body').css("background", "#fff");
    used = true;
    console.log(used);
  }
});
    </script>
</html>